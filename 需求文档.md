# OneDrive MCP 项目需求文档

## 项目概述

### 项目名称
OneDrive MCP (Model Context Protocol) 服务

### 项目目标
开发一个基于 Web 的 MCP 服务，将 OneDrive 网盘内容通过 MCP 协议接入 LLM，实现通过 AI 智能管理网盘文件。

### 核心价值
- **智能文件管理**: 通过自然语言指令管理 OneDrive 文件
- **跨平台访问**: 支持多种 LLM 平台接入
- **安全可控**: 基于 OAuth 2.0 的安全认证机制
- **易于部署**: 支持 Render.com 一键部署

## 功能需求

### 1. 认证与授权模块
- **OneDrive OAuth 2.0 集成**
  - 支持 Microsoft 账户登录
  - 获取访问令牌和刷新令牌
  - 权限范围管理（文件读写、列表查看等）

- **MCP 协议认证**
  - 支持 MCP 标准认证流程
  - API 密钥管理
  - 会话管理

### 2. 文件管理功能
- **文件浏览与搜索**
  - 列出目录内容
  - 递归遍历文件夹
  - 文件搜索（按名称、类型、修改时间）

- **文件操作**
  - 文件上传/下载
  - 文件重命名
  - 文件移动/复制
  - 文件删除
  - 文件夹创建

- **文件预览**
  - 支持常见文件类型预览（文本、图片、PDF等）
  - 文件元数据获取（大小、修改时间、类型等）

### 3. MCP 协议实现

#### 3.1 协议架构
- **传输协议**: HTTP/1.1 + Server-Sent Events (SSE)
- **数据格式**: JSON Schema 规范
- **通信模式**: 双向流式通信

#### 3.2 SSE 流式实现
```typescript
// SSE 连接建立
GET /mcp/sse
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive

// 事件格式
event: message
data: {"type": "tool_call", "callId": "123", "tool": "list_files"}

// 工具调用响应流
event: tool_result
data: {"callId": "123", "content": [{"type": "text", "text": "文件列表..."}]}

// 进度更新
event: progress
data: {"callId": "123", "progress": 50, "message": "正在处理..."}
```

#### 3.3 工具定义（详细规范）

**list_files 工具**
```json
{
  "name": "list_files",
  "description": "列出指定路径下的文件和文件夹",
  "inputSchema": {
    "type": "object",
    "properties": {
      "path": {
        "type": "string",
        "description": "目录路径，默认为根目录"
      },
      "recursive": {
        "type": "boolean",
        "description": "是否递归遍历子目录"
      },
      "limit": {
        "type": "number",
        "description": "返回结果数量限制"
      }
    }
  }
}
```

**read_file 工具**
```json
{
  "name": "read_file",
  "description": "读取文件内容，支持文本文件预览",
  "inputSchema": {
    "type": "object",
    "properties": {
      "fileId": {
        "type": "string",
        "description": "文件ID或路径"
      },
      "encoding": {
        "type": "string",
        "enum": ["utf-8", "base64"],
        "description": "文件编码格式"
      },
      "maxSize": {
        "type": "number",
        "description": "最大读取大小（字节）"
      }
    },
    "required": ["fileId"]
  }
}
```

**write_file 工具**
```json
{
  "name": "write_file",
  "description": "写入或创建文件",
  "inputSchema": {
    "type": "object",
    "properties": {
      "path": {
        "type": "string",
        "description": "文件路径"
      },
      "content": {
        "type": "string",
        "description": "文件内容"
      },
      "overwrite": {
        "type": "boolean",
        "description": "是否覆盖已存在文件"
      }
    },
    "required": ["path", "content"]
  }
}
```

**search_files 工具**
```json
{
  "name": "search_files",
  "description": "搜索文件和文件夹",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "搜索关键词"
      },
      "path": {
        "type": "string",
        "description": "搜索起始路径"
      },
      "fileType": {
        "type": "string",
        "enum": ["file", "folder", "all"],
        "description": "文件类型过滤"
      },
      "maxResults": {
        "type": "number",
        "description": "最大结果数量"
      }
    },
    "required": ["query"]
  }
}
```

#### 3.4 资源管理
- **资源 URI 格式**: `onedrive://{fileId}`
- **资源类型**: `file`, `folder`, `image`, `document`
- **资源元数据**: 包含文件大小、修改时间、MIME类型等

#### 3.5 流式响应处理
```typescript
// 大文件分块读取
interface FileChunk {
  chunkId: string;
  content: string;
  totalChunks: number;
  currentChunk: number;
}

// 上传进度跟踪
interface UploadProgress {
  fileId: string;
  bytesUploaded: number;
  totalBytes: number;
  status: 'uploading' | 'completed' | 'failed';
}

// SSE 连接管理器
interface SSEManager {
  connections: Map<string, ServerResponse>;
  addConnection(clientId: string, res: ServerResponse): void;
  removeConnection(clientId: string): void;
  sendEvent(clientId: string, event: ServerEvent): void;
  broadcast(event: ServerEvent): void;
}
```

#### 3.11 SSE 服务器实现示例
```typescript
// SSE 服务器实现
class MCPServer {
  private sseManager: SSEManager;
  
  // 建立 SSE 连接
  async handleSSEConnection(req: Request, res: Response) {
    res.writeHead(200, {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'Cache-Control'
    });
    
    // 发送初始事件
    res.write(`event: initialized
`);
    res.write(`data: ${JSON.stringify({
      protocolVersion: '2024-11-05',
      capabilities: {
        tools: ['list_files', 'read_file', 'write_file', 'search_files']
      }
    })}

`);
    
    // 处理客户端消息
    req.on('data', (chunk) => {
      const event = JSON.parse(chunk.toString());
      this.handleClientEvent(event, res);
    });
    
    // 连接关闭处理
    req.on('close', () => {
      this.sseManager.removeConnection(req.clientId);
    });
  }
  
  // 处理工具调用
  async handleToolCall(callId: string, tool: string, args: any) {
    // 发送开始事件
    this.sseManager.sendEvent(callId, {
      type: 'progress',
      callId,
      data: { progress: 0, message: '开始处理...' }
    });
    
    try {
      const result = await this.executeTool(tool, args);
      
      // 流式返回结果
      if (result.stream) {
        for await (const chunk of result.stream) {
          this.sseManager.sendEvent(callId, {
            type: 'tool_result_chunk',
            callId,
            data: chunk
          });
        }
      } else {
        this.sseManager.sendEvent(callId, {
          type: 'tool_result',
          callId,
          data: result
        });
      }
    } catch (error) {
      this.sseManager.sendEvent(callId, {
        type: 'error',
        callId,
        data: { message: error.message }
      });
    }
  }
}
```

#### 3.12 客户端 SSE 实现示例
```typescript
// 客户端 SSE 连接
class MCPClient {
  private eventSource: EventSource | null = null;
  private callbacks: Map<string, Function> = new Map();
  
  async connect(apiKey: string): Promise<void> {
    return new Promise((resolve, reject) => {
      this.eventSource = new EventSource(`/mcp/sse?apiKey=${apiKey}`);
      
      this.eventSource.onopen = () => resolve();
      this.eventSource.onerror = (error) => reject(error);
      
      // 监听服务端事件
      this.eventSource.addEventListener('tool_result', this.handleToolResult.bind(this));
      this.eventSource.addEventListener('progress', this.handleProgress.bind(this));
      this.eventSource.addEventListener('error', this.handleError.bind(this));
    });
  }
  
  // 调用工具
  async callTool(tool: string, args: any): Promise<any> {
    const callId = this.generateCallId();
    
    return new Promise((resolve, reject) => {
      this.callbacks.set(callId, { resolve, reject });
      
      // 发送工具调用请求
      fetch('/mcp/tools/call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ callId, tool, arguments: args })
      });
    });
  }
  
  private handleToolResult(event: MessageEvent) {
    const data = JSON.parse(event.data);
    const callback = this.callbacks.get(data.callId);
    
    if (callback) {
      callback.resolve(data.result);
      this.callbacks.delete(data.callId);
    }
  }
}
```

### 4. Web 管理界面
- **仪表板**
  - 网盘使用情况统计
  - 最近访问文件
  - 快速操作面板

- **文件浏览器**
  - 树形目录结构
  - 文件列表视图
  - 搜索和筛选功能

- **MCP 配置**
  - API 密钥生成
  - 连接测试
  - 使用统计

## 技术架构

### 前端技术栈
- **框架**: React 18 + TypeScript
- **UI 组件**: Material-UI (MUI) 或 Ant Design
- **状态管理**: Redux Toolkit + RTK Query
- **路由**: React Router v6
- **构建工具**: Vite

### 后端技术栈
- **运行时**: Node.js 18+
- **框架**: Express.js + TypeScript
- **认证**: Passport.js + OAuth2
- **MCP 协议**: 实现 MCP 服务器规范
- **SSE 支持**: 原生 Node.js HTTP 流 + EventSource
- **API 文档**: Swagger/OpenAPI
- **流式处理**: 支持大文件分块传输和进度跟踪

### 数据库
- **主数据库**: PostgreSQL (Render.com 托管)
- **缓存**: Redis (会话缓存)
- **文件存储**: OneDrive API (无需本地存储)

### 部署架构
- **平台**: Render.com
- **Web 服务**: 静态前端 + API 后端
- **数据库**: Render.com PostgreSQL
- **环境变量**: Render.com 环境配置

## API 设计

### MCP 协议端点（SSE 流式实现）

#### 3.6 SSE 连接端点
```
GET /mcp/sse
Headers:
  Content-Type: text/event-stream
  Cache-Control: no-cache
  Connection: keep-alive
  Authorization: Bearer {api_key}
```

#### 3.7 事件类型定义
```typescript
// 客户端发送的事件
interface ClientEvent {
  type: 'initialize' | 'tools_call' | 'resources_list' | 'resources_read';
  callId: string;
  data?: any;
}

// 服务端发送的事件
interface ServerEvent {
  type: 'initialized' | 'tool_result' | 'resource_content' | 'progress' | 'error';
  callId: string;
  data: any;
}
```

#### 3.8 流式工具调用流程
```
1. 客户端建立 SSE 连接
2. 发送初始化事件
3. 服务端返回可用工具列表
4. 客户端发送工具调用请求
5. 服务端流式返回结果（支持进度更新）
6. 连接保持，支持多个工具调用
```

#### 3.9 具体 API 端点

**SSE 连接建立**
```
GET /mcp/sse
```

**工具调用（通过 SSE）**
```
事件格式:
event: tools_call
data: {
  "callId": "unique-id",
  "tool": "list_files",
  "arguments": {"path": "/documents"}
}
```

**资源访问（通过 SSE）**
```
事件格式:
event: resources_read
data: {
  "callId": "unique-id",
  "uri": "onedrive://file123"
}
```

### REST API 端点（Web 界面使用）
```
GET  /api/auth/onedrive   # 启动 OneDrive 认证
GET  /api/auth/callback   # OAuth 回调
GET  /api/files           # 获取文件列表
GET  /api/files/:id       # 获取文件详情
POST /api/files           # 上传文件（支持分块上传）
PUT  /api/files/:id       # 更新文件
DELETE /api/files/:id     # 删除文件

# MCP 配置管理
GET  /api/mcp/config      # 获取 MCP 配置
POST /api/mcp/config      # 更新 MCP 配置
GET  /api/mcp/keys        # 获取 API 密钥列表
POST /api/mcp/keys        # 创建新的 API 密钥
DELETE /api/mcp/keys/:id  # 删除 API 密钥
```

### 3.10 流式上传/下载端点
```
# 大文件分块上传
POST /api/files/upload/chunk
Content-Type: multipart/form-data

# 大文件分块下载
GET /api/files/download/chunk/:fileId
Range: bytes=0-1023

# 上传进度查询
GET /api/files/upload/progress/:uploadId
```

## 安全设计

### 认证安全
- OAuth 2.0 with PKCE
- JWT 令牌管理
- 安全的令牌存储和刷新

### 数据安全
- HTTPS 强制加密
- 敏感数据加密存储
- API 速率限制
- CORS 策略配置

### 权限控制
- 基于角色的访问控制
- 文件操作权限验证
- 会话超时管理

## 部署要求

### Render.com 配置
- **Web Service**: Node.js 运行时
- **PostgreSQL**: 数据库附加服务
- **环境变量**:
  - `ONEDRIVE_CLIENT_ID`
  - `ONEDRIVE_CLIENT_SECRET`
  - `DATABASE_URL`
  - `JWT_SECRET`
  - `REDIS_URL`

### 构建配置
- 自动构建和部署
- 健康检查端点
- 日志和监控配置

## 开发计划

### 第一阶段：基础架构 (2-3周)
- [ ] 项目初始化和技术栈搭建
- [ ] 数据库设计和迁移
- [ ] 基础认证系统
- [ ] OneDrive API 集成

### 第二阶段：核心功能 (3-4周)
- [ ] MCP 协议实现
- [ ] 文件管理功能
- [ ] Web 管理界面
- [ ] API 文档和测试

### 第三阶段：优化部署 (1-2周)
- [ ] 性能优化
- [ ] 安全加固
- [ ] Render.com 部署
- [ ] 用户文档编写

## 成功指标

### 功能指标
- ✅ 支持完整的文件 CRUD 操作
- ✅ MCP 协议工具调用成功率 > 99%
- ✅ 认证流程用户体验良好
- ✅ 响应时间 < 2秒

### 技术指标
- ✅ 代码测试覆盖率 > 80%
- ✅ 安全漏洞扫描通过
- ✅ 部署流程自动化
- ✅ 监控和日志完善

## 风险与缓解

### 技术风险
- **OneDrive API 限制**: 实现合理的 API 调用频率控制
- **MCP 协议变更**: 保持协议实现的灵活性
- **部署复杂性**: 使用容器化部署简化流程

### 业务风险
- **用户接受度**: 提供清晰的使用文档和示例
- **竞争产品**: 专注于 MCP 集成的独特价值
- **合规要求**: 遵循数据保护和隐私法规

## 后续扩展

### 功能扩展
- 支持其他云存储服务（Google Drive, Dropbox）
- 文件智能分类和标签
- 批量操作和自动化任务
- 协作和分享功能

### 技术扩展
- 移动端应用
- 桌面客户端
- 浏览器扩展
- CLI 工具

---

## 文档版本
- **版本**: 1.0
- **创建日期**: 2025-11-15
- **最后更新**: 2025-11-15
- **状态**: 草案