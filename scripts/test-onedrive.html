<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneDrive è®¤è¯ä¸æ–‡ä»¶è®¿é—®æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #0078d4;
            margin-top: 0;
        }

        h2 {
            color: #333;
            font-size: 1.2em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover {
            background: #106ebe;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #e1e4e8;
            max-height: 300px;
        }

        .step {
            margin-bottom: 20px;
            opacity: 0.5;
            pointer-events: none;
        }

        .step.active {
            opacity: 1;
            pointer-events: all;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>OneDrive æµ‹è¯•å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯• Render éƒ¨ç½²åçš„ OneDrive è®¤è¯å’Œæ–‡ä»¶è®¿é—®åŠŸèƒ½ã€‚</p>
        <div style="margin-bottom: 15px;">
            <label>æœåŠ¡å™¨åœ°å€:</label>
            <input type="text" id="serverUrl" value="https://onedrivermcp.onrender.com">
        </div>
    </div>

    <div class="card step active" id="step1">
        <h2>ç¬¬ä¸€æ­¥ï¼šè·å–æˆæƒ URL</h2>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å– Microsoft ç™»å½•é“¾æ¥ã€‚</p>
        <button onclick="getAuthUrl()">è·å–æˆæƒé“¾æ¥</button>
        <div id="authUrlResult"></div>
    </div>

    <div class="card step" id="step2">
        <h2>ç¬¬äºŒæ­¥ï¼šç™»å½•å¹¶è·å– Token</h2>
        <p>1. ç‚¹å‡»ä¸Šæ–¹ç”Ÿæˆçš„é“¾æ¥è¿›è¡Œç™»å½•ã€‚<br>
            2. ç™»å½•æˆåŠŸåï¼Œæµè§ˆå™¨åœ°å€æ ä¼šæ˜¾ç¤ºå›è°ƒ URLã€‚<br>
            3. å¤åˆ¶å›è°ƒ URL ä¸­çš„ <code>code</code> å‚æ•°ï¼Œæˆ–è€…ç›´æ¥å¤åˆ¶æ•´ä¸ªå›è°ƒ URL ç²˜è´´åˆ°ä¸‹æ–¹ã€‚</p>
        <input type="text" id="callbackUrl" placeholder="ç²˜è´´å›è°ƒ URL æˆ– code...">
        <button onclick="exchangeToken()">æ¢å– Token</button>
        <div id="tokenResult"></div>
    </div>

    <div class="card step" id="step3">
        <h2>ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•æ–‡ä»¶è®¿é—®</h2>
        <p>ä½¿ç”¨è·å–åˆ°çš„ Token è®¿é—® OneDrive æ–‡ä»¶åˆ—è¡¨ã€‚</p>
        <button onclick="listFiles()">åˆ—å‡ºæ ¹ç›®å½•æ–‡ä»¶</button>
        <div id="filesResult"></div>
    </div>

    <script>
        let accessToken = '';

        function getServerUrl() {
            return document.getElementById('serverUrl').value.replace(/\/$/, '');
        }

        function showResult(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<pre style="color: ${isError ? '#721c24' : '#333'}">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>`;
        }

        function activateStep(stepId) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
            // ä¿æŒä¹‹å‰çš„æ­¥éª¤ä¹Ÿå¯è§ä½†ä¸å¯æ“ä½œï¼ˆå¯é€‰ï¼Œè¿™é‡Œç®€å•å¤„ç†ä¸ºé«˜äº®å½“å‰æ­¥éª¤ï¼‰
            for (let i = 1; i < parseInt(stepId.replace('step', '')); i++) {
                document.getElementById('step' + i).style.opacity = '0.8';
            }
        }

        async function getAuthUrl() {
            const serverUrl = getServerUrl();
            try {
                const res = await fetch(`${serverUrl}/api/oauth/authorize`);
                const data = await res.json();

                if (data.success && data.data.authorizationUrl) {
                    const authUrl = data.data.authorizationUrl;
                    showResult('authUrlResult', `æˆæƒé“¾æ¥å·²ç”Ÿæˆï¼\n\nè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è¿›è¡Œç™»å½•ï¼š\n<a href="${authUrl}" target="_blank" style="display:inline-block;margin-top:10px;padding:10px 20px;background:#28a745;color:white;text-decoration:none;border-radius:4px;">å‰å¾€ Microsoft ç™»å½•</a>`);
                    document.getElementById('step2').classList.add('active');
                } else {
                    showResult('authUrlResult', data, true);
                }
            } catch (err) {
                showResult('authUrlResult', `è¯·æ±‚å¤±è´¥: ${err.message}\nè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠ CORS æ˜¯å¦é…ç½®å…è®¸ã€‚`, true);
            }
        }

        async function exchangeToken() {
            const input = document.getElementById('callbackUrl').value.trim();
            if (!input) return alert('è¯·è¾“å…¥å›è°ƒ URL æˆ– code');

            let code = input;
            // å°è¯•ä» URL ä¸­æå– code
            try {
                const url = new URL(input);
                code = url.searchParams.get('code');
            } catch (e) {
                // ä¸æ˜¯ URLï¼Œå‡è®¾æ˜¯ code
            }

            if (!code) return alert('æ— æ³•æå– codeï¼Œè¯·æ£€æŸ¥è¾“å…¥');

            const serverUrl = getServerUrl();
            try {
                // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾åç«¯æœ‰ä¸€ä¸ªç«¯ç‚¹å¯ä»¥ç”¨ code æ¢ token
                // å¦‚æœåç«¯æ˜¯ç›´æ¥åœ¨ callback è·¯ç”±å¤„ç†å¹¶è¿”å› tokenï¼Œæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿè¿™ä¸ªè¯·æ±‚
                // é€šå¸¸ callback è·¯ç”±æ˜¯ GET è¯·æ±‚
                const res = await fetch(`${serverUrl}/api/oauth/callback?code=${code}`);
                const data = await res.json();

                if (data.accessToken || (data.data && data.data.accessToken)) {
                    accessToken = data.accessToken || data.data.accessToken;
                    showResult('tokenResult', `ğŸ‰ è®¤è¯æˆåŠŸï¼\n\nAccess Token: ${accessToken.substring(0, 20)}...`);
                    document.getElementById('step3').classList.add('active');
                } else {
                    // æœ‰äº›åç«¯å¯èƒ½ç›´æ¥è¿”å› HTML é¡µé¢ï¼Œè¿™åœ¨å‰åç«¯åˆ†ç¦»æµ‹è¯•æ—¶æ¯”è¾ƒéº»çƒ¦
                    // å¦‚æœè¿”å›çš„æ˜¯ HTMLï¼Œè¯´æ˜åç«¯å¤„ç†äº† callback ä½†æ²¡æœ‰è¿”å› JSON
                    // è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸åç«¯ä¼šè®¾ç½® cookie æˆ–é‡å®šå‘
                    showResult('tokenResult', data, true);
                }
            } catch (err) {
                showResult('tokenResult', `è¯·æ±‚å¤±è´¥: ${err.message}`, true);
            }
        }

        async function listFiles() {
            if (!accessToken) return alert('è¯·å…ˆè·å– Token');

            const serverUrl = getServerUrl();
            try {
                const res = await fetch(`${serverUrl}/api/files`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await res.json();
                showResult('filesResult', data);
            } catch (err) {
                showResult('filesResult', `è¯·æ±‚å¤±è´¥: ${err.message}`, true);
            }
        }
    </script>
</body>

</html>